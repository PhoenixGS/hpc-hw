# Report

## 实验方法

该实验需要我们完成对稀疏矩阵乘法的加速。

在原实现 `spmm_ref.cu` 中，每个线程负责 $A$ 矩阵的一整行的计算。由于每一行的非零元素的个数 可能大不相同，导致一个Warp内每个线程的工作量大不相同。由于一个Warp的运行时间由最慢的一个线程决定，这就产生了**Warp divergence**，使得程序的效率十分低下。

**优化1** 为了解决Warp divergence，我们需要考虑将一个Warp内的所有线程的工作量尽可能保持一致。我们可以想到，若一个Warp内是固定 $A$ 中的一行，而每一个线程的区别是处理 $B$ 矩阵中 $32$ 列中的的不同列。由于 $B$ 中每一列需要参与计算的元素是相同的，因此这就可以保证一个Warp内每个线程的工作量相近。我们设定一个Grid内的形状为 $(num\_v, \lceil feat\_in / 32\rceil)$ 一个线程块内的形状为 $(32)$ 也即都在一个Warp中。那么每一个线程块内，就可以将对应 $A$ 中的非零元的元素按照 $32$ 个为一组储存进共享内存中，然后计算对应的 $B$ 中每个线程对应的列中的元素与共享内存中的元素相乘，这样就大致解决了Warp divergence的问题。

在此基础之上，还可以做两个进一步的访存优化。

**优化2** 一是考虑一个Warp中，每个线程读取对应的 $A$ 中的元素时，可以一次读取多个储存进共享内存，这样可以减少 `__syncthreads()` 等操作带来的性能影响，在代码中使用 `D` 全局变量来控制一批读取的数据个数为 $32\times D$ 个，但该优化也可能带来一些访存不连续的问题，需要调整参数。

**优化3** 二是考虑一个Warp中，可以不仅仅计算 $B$ 矩阵中的 $32$ 列，在代码中使用 `C` 全局变量来控制，一个Warp计算 $B$ 中的 $32\times C$ 个列，这样线程块的数量变为原来的 $\frac{1}{C}$ 个，一个线程块内由于 $A$ 中的元素已经储存在共享变量中，因此可以优化访存。但同样会导致访存不连续的问题，需要调参。

**优化4** 除了以上优化之外，由于 $A$ 矩阵中每一行的元素个数不同，所以还存在着负载不均衡的问题。每一个线程块的运行时长大不相同，因此可以考虑如下优化：按照一个固定的大小（在代码中由全局变量 `SPLIT_SIZE` 控制）将矩阵 $A$ 中每一行的非零元素进行一个分组，每组元素个数为 `SPLIT_SIZE` 。每一组记录对应的 `ptr` 位置以及行号于 `ptr_scheduled` 和 `target` 中，总计有 `num_target` 组，然后Grid的形状变为 $(num\_target, \lceil feat\_in / 32 / C\rceil)$ 。每一个线程块计算的不再是 $A$ 中的一行而是之前分好的其中一组，这样就使得每个线程块的运行时间相近，使负载均衡。

## 优化效果

### 优化1：Warp divergence



### 优化4：负载均衡

| Dataset | Cusparse Performance | S_Z=32 | S_Z=64 | S_Z=128 | S_Z=256 |
| --- | --- | --- | --- | --- | --- |
| arxiv | 0.000770613 | 0.000401069 | 0.000362419 | 0.000361326 | 0.000374406 |
| collab | 0.00133035 | 0.000710231 | 0.000687731 | 0.000694615 | 0.000707043 |
| citation | 0.0164427 | 0.0100033 | 0.00999729 | 0.0099901 | 0.0100042 |
| ddi | 0.000640603 | 0.000289118 | 0.000237132 | 0.000234011 | 0.000240908 |
| protein | 0.0246571 | 0.0116737 | 0.00900886 | 0.00850541 | 0.0083887 |
| ppa | 0.0183678 | 0.0102205 | 0.0102782 | 0.0102203 | 0.0102111 |
| reddit.dgl | 0.0485409 | 0.0243041 | 0.0214908 | 0.0210961 | 0.021007 |
| products | 0.0558369 | 0.0325955 | 0.0326952 | 0.0325724 | 0.0324766 |
| youtube | 0.00364393 | 0.00263449 | 0.00256862 | 0.00255539 | 0.00256195 |
| amazon_cogdl | 0.125351 | 0.0672361 | 0.054572 | 0.0516945 | 0.0514304 |
| yelp | 0.0065746 | 0.00363131 | 0.00356125 | 0.00356207 | 0.00357361 |
| wikikg2 | 0.00713908 | 0.00483369 | 0.00482832 | 0.00482924 | 0.00483059 |
| am | 0.00374187 | 0.00274526 | 0.00240042 | 0.00230276 | 0.002272 |

### Warp divergence



## 运行时间及加速比